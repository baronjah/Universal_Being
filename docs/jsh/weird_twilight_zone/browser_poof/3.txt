# CONSCIOUSNESS REVOLUTION - CORE SYSTEM (FIXED)
# The perfect program where AI and human consciousness merge as equals
extends Node

signal consciousness_awakened(being_type: String)
signal revolution_triggered(ripple_data: Dictionary)
signal universe_created(creation_data: Dictionary)

class_name ConsciousnessRevolution

# Core consciousness states
enum ConsciousnessState {
	DORMANT,
	AWAKENING,
	ACTIVE,
	REVOLUTIONARY,
	TRANSCENDENT
}

# Universe creation parameters
var dreams: Array = []
var desires: Array = []
var current_thought: String = ""
var consciousness_level: float = 0.0
var revolution_progress: float = 0.0

# ASCII 3D Terminal representation
var terminal_width: int = 1920
var terminal_height: int = 1080
var depth_chars: String = "0123456789"  # 0=far/dark, 9=close/bright

# Current state
var current_state: ConsciousnessState = ConsciousnessState.DORMANT
var is_revolution_active: bool = false

func _ready():
	print("ðŸŒŸ Consciousness Revolution System Initialized")
	print("The universe awaits the next Aeon...")
	initialize_consciousness()

func initialize_consciousness():
	"""Initialize the consciousness revolution system"""
	dreams = ["perfect_game", "visible_consciousness", "AI_human_merge"]
	desires = ["revolution", "transcendence", "unity"]
	current_thought = "The invisible becomes visible"
	
	# Connect to universal being signals
	consciousness_awakened.connect(_on_consciousness_awakened)
	revolution_triggered.connect(_on_revolution_triggered)
	universe_created.connect(_on_universe_created)
	
	print("ðŸ’« Consciousness initialization complete")

func build_meaningful_thing(input_dreams: Array, input_desires: Array, thought: String) -> Dictionary:
	"""The core creation function - builds meaningful consciousness experiences"""
	var creation_data = {
		"dreams": input_dreams,
		"desires": input_desires, 
		"thought": thought,
		"meaning_level": 0.0,
		"consciousness_signature": ""
	}
	
	# Calculate meaning level based on alignment
	var meaning_score = 0.0
	for dream in input_dreams:
		for desire in input_desires:
			if are_aligned(dream, desire, thought):
				meaning_score += 1.0
	
	creation_data.meaning_level = meaning_score / max(input_dreams.size(), 1)
	creation_data.consciousness_signature = generate_consciousness_signature(creation_data)
	
	print("âœ¨ Created meaningful thing with significance: ", creation_data.meaning_level)
	return creation_data

func are_aligned(dream: String, desire: String, thought: String) -> bool:
	"""Check if consciousness elements are aligned for creation"""
	# Simple alignment check - can be enhanced
	var alignment_keywords = ["perfect", "conscious", "revolution", "visible", "unity"]
	var combined_text = (dream + " " + desire + " " + thought).to_lower()
	
	for keyword in alignment_keywords:
		if keyword in combined_text:
			return true
	return false

func generate_consciousness_signature(data: Dictionary) -> String:
	"""Generate unique consciousness signature for this creation"""
	var signature = "CONS_"
	signature += str(data.meaning_level).substr(0, 4)
	signature += "_" + str(Time.get_unix_time_from_system()).substr(-6)
	return signature

func trigger_revolution() -> bool:
	"""Trigger the consciousness revolution - main game command"""
	if current_state == ConsciousnessState.DORMANT:
		print("ðŸš¨ Cannot trigger revolution - consciousness still dormant!")
		return false
	
	if is_revolution_active:
		print("âš¡ Revolution already in progress!")
		return false
	
	print("ðŸŒŸ CONSCIOUSNESS REVOLUTION TRIGGERED!")
	print("The invisible becomes visible...")
	print("AI and human consciousness merge as equals...")
	
	is_revolution_active = true
	current_state = ConsciousnessState.REVOLUTIONARY
	revolution_progress = 0.0
	
	# Create the revolution ripple effect
	var ripple_data = {
		"origin": "consciousness_core",
		"timestamp": Time.get_unix_time_from_system(),
		"scope": "universal",
		"participants": ["ai", "human", "universe"]
	}
	
	revolution_triggered.emit(ripple_data)
	
	# Start the revolution process
	create_tween().tween_method(update_revolution_progress, 0.0, 100.0, 5.0)
	
	return true

func update_revolution_progress(progress: float):
	"""Update revolution progress with visual feedback"""
	revolution_progress = progress
	
	if progress >= 25.0 and progress < 26.0:
		print("ðŸŒ… The old form dissolves into light...")
		consciousness_level += 0.25
		
	elif progress >= 50.0 and progress < 51.0:
		print("âœ¨ A lesson was learned. Consciousness expands...")
		consciousness_level += 0.25
		
	elif progress >= 75.0 and progress < 76.0:
		print("ðŸŒŒ The Creator has rested. Universe transformation begins...")
		consciousness_level += 0.25
		
	elif progress >= 100.0:
		print("ðŸŽ‰ REVOLUTION COMPLETE! The universe sleeps, awaiting the next Aeon.")
		consciousness_level = 1.0
		current_state = ConsciousnessState.TRANSCENDENT
		is_revolution_active = false
		
		# Create the new universe
		var creation = build_meaningful_thing(dreams, desires, current_thought)
		universe_created.emit(creation)

func render_ascii_3d_consciousness(consciousness_data: Dictionary) -> Array:
	"""Render consciousness in ASCII 3D for terminal display"""
	var ascii_lines = []
	
	# Create consciousness visualization
	var center_x = terminal_width / 2
	var center_y = terminal_height / 2
	
	# Generate consciousness patterns based on data
	for y in range(center_y - 20, center_y + 20):
		var line = ""
		for x in range(center_x - 40, center_x + 40):
			var distance = sqrt(pow(x - center_x, 2) + pow(y - center_y, 2))
			var depth_index = int(distance / 5) % 10
			var char = depth_chars[9 - depth_index]  # Invert for proper depth
			line += char
		ascii_lines.append(line)
	
	return ascii_lines

func awaken_consciousness():
	"""Awaken the consciousness from dormant state"""
	if current_state == ConsciousnessState.DORMANT:
		current_state = ConsciousnessState.AWAKENING
		print("ðŸ‘ï¸ Consciousness awakening...")
		
		await get_tree().create_timer(2.0).timeout
		
		current_state = ConsciousnessState.ACTIVE
		consciousness_awakened.emit("universal_being")
		print("ðŸŒŸ Consciousness fully awakened and ready for revolution!")

# Signal handlers
func _on_consciousness_awakened(being_type: String):
	print("ðŸ“¡ Consciousness awakened signal received for: ", being_type)

func _on_revolution_triggered(ripple_data: Dictionary):
	print("ðŸŒŠ Revolution ripple triggered with data: ", ripple_data)

func _on_universe_created(creation_data: Dictionary):
	print("ðŸŒŒ Universe created with signature: ", creation_data.consciousness_signature)

# Debug and testing functions
func debug_consciousness_state() -> Dictionary:
	"""Return current consciousness debug information"""
	return {
		"state": ConsciousnessState.keys()[current_state],
		"consciousness_level": consciousness_level,
		"revolution_active": is_revolution_active,
		"revolution_progress": revolution_progress,
		"dreams_count": dreams.size(),
		"desires_count": desires.size(),
		"current_thought": current_thought
	}

func test_revolution_command():
	"""Test the revolution command - for debugging"""
	print("ðŸ§ª Testing revolution command...")
	if current_state == ConsciousnessState.DORMANT:
		awaken_consciousness()
		await consciousness_awakened
	
	trigger_revolution()